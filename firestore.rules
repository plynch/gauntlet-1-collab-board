rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function boardDocPath(boardId) {
      return /databases/$(database)/documents/boards/$(boardId);
    }

    function boardExists(boardId) {
      return exists(boardDocPath(boardId));
    }

    function boardData(boardId) {
      return get(boardDocPath(boardId)).data;
    }

    function uidInList(candidateList) {
      return candidateList is list && candidateList.hasAny([request.auth.uid]);
    }

    function canReadBoardDoc(board) {
      return board.openRead == true
        || board.openEdit == true
        || board.ownerId == request.auth.uid
        || uidInList(board.readerIds)
        || uidInList(board.editorIds);
    }

    function canEditBoardDoc(board) {
      return board.openEdit == true
        || board.ownerId == request.auth.uid
        || uidInList(board.editorIds);
    }

    function hasValidBoardFieldSet(board) {
      return board.keys().hasOnly([
        "title",
        "ownerId",
        "openEdit",
        "openRead",
        "editorIds",
        "readerIds",
        "createdAt",
        "updatedAt"
      ]);
    }

    function hasValidBoardFieldTypes(board) {
      return board.title is string
        && board.ownerId is string
        && board.openEdit is bool
        && board.openRead is bool
        && board.editorIds is list
        && board.readerIds is list;
    }

    function isAllowedBoardObjectType(value) {
      return value in [
        "sticky",
        "text",
        "rect",
        "circle",
        "gridContainer",
        "line",
        "connectorUndirected",
        "connectorArrow",
        "connectorBidirectional",
        "triangle",
        "star"
      ];
    }

    function hasOnlyBoardObjectFields(data) {
      return data.keys().hasOnly([
        "type",
        "zIndex",
        "x",
        "y",
        "width",
        "height",
        "rotationDeg",
        "color",
        "text",
        "fromObjectId",
        "toObjectId",
        "fromAnchor",
        "toAnchor",
        "fromX",
        "fromY",
        "toX",
        "toY",
        "gridRows",
        "gridCols",
        "gridGap",
        "gridCellColors",
        "containerTitle",
        "gridSectionTitles",
        "gridSectionNotes",
        "containerId",
        "containerSectionIndex",
        "containerRelX",
        "containerRelY",
        "createdAt",
        "updatedAt"
      ]);
    }

    function hasValidOptionalNumberField(data, fieldName) {
      return !(fieldName in data) || data[fieldName] is number || data[fieldName] == null;
    }

    function hasValidOptionalStringField(data, fieldName) {
      return !(fieldName in data) || data[fieldName] is string || data[fieldName] == null;
    }

    function hasValidBoardObjectData(data) {
      return hasOnlyBoardObjectFields(data)
        && data.type is string
        && isAllowedBoardObjectType(data.type)
        && data.zIndex is number
        && data.x is number
        && data.y is number
        && data.width is number
        && data.height is number
        && data.rotationDeg is number
        && data.color is string
        && data.text is string
        && hasValidOptionalStringField(data, "fromObjectId")
        && hasValidOptionalStringField(data, "toObjectId")
        && hasValidOptionalStringField(data, "fromAnchor")
        && hasValidOptionalStringField(data, "toAnchor")
        && hasValidOptionalNumberField(data, "fromX")
        && hasValidOptionalNumberField(data, "fromY")
        && hasValidOptionalNumberField(data, "toX")
        && hasValidOptionalNumberField(data, "toY")
        && hasValidOptionalNumberField(data, "gridRows")
        && hasValidOptionalNumberField(data, "gridCols")
        && hasValidOptionalNumberField(data, "gridGap")
        && (!( "gridCellColors" in data) || data.gridCellColors is list || data.gridCellColors == null)
        && hasValidOptionalStringField(data, "containerTitle")
        && (!( "gridSectionTitles" in data) || data.gridSectionTitles is list || data.gridSectionTitles == null)
        && (!( "gridSectionNotes" in data) || data.gridSectionNotes is list || data.gridSectionNotes == null)
        && hasValidOptionalStringField(data, "containerId")
        && hasValidOptionalNumberField(data, "containerSectionIndex")
        && hasValidOptionalNumberField(data, "containerRelX")
        && hasValidOptionalNumberField(data, "containerRelY");
    }

    function hasValidPresenceData(data, userId) {
      return data.keys().hasOnly([
          "uid",
          "displayName",
          "email",
          "color",
          "active",
          "cursorX",
          "cursorY",
          "lastSeenAtMs",
          "lastSeenAt"
        ])
        && data.uid is string
        && data.uid == userId
        && (!( "displayName" in data) || data.displayName is string || data.displayName == null)
        && (!( "email" in data) || data.email is string || data.email == null)
        && (!( "color" in data) || data.color is string || data.color == null)
        && data.active is bool
        && hasValidOptionalNumberField(data, "cursorX")
        && hasValidOptionalNumberField(data, "cursorY")
        && hasValidOptionalNumberField(data, "lastSeenAtMs")
        && (!( "lastSeenAt" in data) || data.lastSeenAt is timestamp || data.lastSeenAt == null);
    }

    function isBoardUpdateSafe() {
      return request.resource.data.ownerId == resource.data.ownerId
        && request.resource.data.createdAt == resource.data.createdAt
        && hasValidBoardFieldSet(request.resource.data)
        && hasValidBoardFieldTypes(request.resource.data);
    }

    function canReadBoard(boardId) {
      return isSignedIn()
        && boardExists(boardId)
        && canReadBoardDoc(boardData(boardId));
    }

    function canEditBoard(boardId) {
      return isSignedIn()
        && boardExists(boardId)
        && canEditBoardDoc(boardData(boardId));
    }

    match /users/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    match /boards/{boardId} {
      // Note: owner board count limits (max 3) should be enforced server-side.
      allow create: if isSignedIn()
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.openEdit is bool
        && request.resource.data.openRead is bool
        && hasValidBoardFieldSet(request.resource.data)
        && hasValidBoardFieldTypes(request.resource.data)
        && request.resource.data.editorIds.size() == 0
        && request.resource.data.readerIds.size() == 0;

      allow get, list: if isSignedIn() && canReadBoardDoc(resource.data);
      allow update: if isSignedIn()
        && resource.data.ownerId == request.auth.uid
        && isBoardUpdateSafe();
      allow delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    match /boards/{boardId}/objects/{objectId} {
      allow read: if canReadBoard(boardId);
      allow create, update: if canEditBoard(boardId)
        && hasValidBoardObjectData(request.resource.data);
      allow delete: if canEditBoard(boardId);
    }

    match /boards/{boardId}/presence/{userId} {
      allow read: if canReadBoard(boardId);

      allow create, update, delete: if canReadBoard(boardId)
        && isSignedIn()
        && request.auth.uid == userId
        && hasValidPresenceData(request.resource.data, userId);
    }
  }
}
